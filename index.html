<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Cat Calorie Calculator</title>
<style>
:root{
  --bg:#0b1220; --bg2:#0a0f1a; --card:#0f1628; --line:#1c2742;
  --text:#eaf1ff; --muted:#9fb0c7; --accent:#4cc9f0; --accent2:#b5179e;
  --danger:#ff6b6b; --ok:#2dd4bf; --radius:16px;
}
*{box-sizing:border-box} html,body{height:100%}
body{
  margin:0; color:var(--text);
  background:
    radial-gradient(1200px 900px at 10% -10%, rgba(76,201,240,.08), transparent 60%),
    radial-gradient(900px 600px at 110% -10%, rgba(181,23,158,.06), transparent 50%),
    linear-gradient(180deg,var(--bg) 0%, var(--bg2) 100%);
  font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, "Noto Naskh Arabic", "Noto Kufi Arabic", sans-serif;
}
header{position:sticky;top:0;z-index:5;backdrop-filter:saturate(160%) blur(8px);border-bottom:1px solid var(--line);
  background:linear-gradient(180deg, rgba(11,18,32,.9), rgba(11,18,32,.6));}
.nav{max-width:1100px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;padding:14px 16px}
.brand{display:flex;align-items:center;gap:10px}
.logo{width:34px;height:34px;border-radius:10px;background: radial-gradient(16px 16px at 70% 30%, var(--accent), transparent), linear-gradient(135deg,var(--accent2), var(--accent)); box-shadow:0 6px 18px rgba(76,201,240,.35), inset 0 0 24px rgba(255,255,255,.08)}
.title{font-weight:800;margin:0;font-size:18px;letter-spacing:.3px}
.lang{display:flex;align-items:center;border:1px solid var(--line);border-radius:999px;overflow:hidden}
.lang button{background:transparent;color:#bcd0ef;border:none;padding:8px 14px;cursor:pointer;font-weight:800;min-width:52px}
.lang button.active{color:white;background:linear-gradient(135deg,var(--accent2),var(--accent))}
main{max-width:1100px;margin:24px auto;padding:0 16px 40px}
.grid{display:grid;grid-template-columns:1.1fr .9fr;gap:18px}
@media(max-width:940px){.grid{grid-template-columns:1fr}}
.card{background:linear-gradient(180deg, rgba(255,255,255,.02), transparent 30%), var(--card);
  border:1px solid var(--line); border-radius:var(--radius); padding:18px; box-shadow:0 10px 30px rgba(0,0,0,.35)}
.section-title{font-weight:900;margin:2px 0 14px 0;font-size:20px}
label{display:block;font-size:12.5px;color:#9fb0c7;margin:6px 0 8px 0}
input,select{width:100%;padding:13px 12px;border-radius:12px;background:#0b1324;color:var(--text);
  border:1px solid #22304f;font-size:15px;box-shadow:inset 0 1px 0 rgba(255,255,255,.04)}
input::placeholder{color:#6f7c95}
.row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media(max-width:600px){.row{grid-template-columns:1fr}}
.toggles{display:flex;gap:12px;flex-wrap:wrap;margin-top:8px}
.toggle{display:flex;align-items:center;gap:8px;padding:8px 10px;border:1px dashed #2a385c;border-radius:10px;background:#0b1324}
.toggle input{width:auto}
.error{font-size:13px;background:rgba(255,107,107,.12);border:1px solid var(--danger);color:#ffd1d1;padding:10px 12px;border-radius:12px;margin:10px 0;display:none}
.cta{margin-top:12px;display:flex;gap:12px;flex-wrap:wrap}
button{cursor:pointer;border-radius:12px;padding:12px 18px;font-weight:900;letter-spacing:.2px;background:linear-gradient(135deg,var(--accent),var(--accent2));border:0;color:white}
button.secondary{background:#0b1324;color:var(--text);border:1px solid #22304f}
.stat{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border:1px dashed #2a385c;border-radius:12px;margin:8px 0;background:#0b1324}
.stat .k{font-weight:800}
.hide{display:none !important}
footer{border-top:1px solid var(--line);margin-top:24px;padding:16px;color:#9fb0c7;text-align:center;font-size:13px}
.small{font-size:12px}

/* compact results grid */
.result-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.mini{border:1px dashed var(--line);border-radius:16px;padding:18px 14px;text-align:center}
.mini-label{font-weight:700;margin-bottom:8px}
.mini-value{font-size:18px}
@media (min-width:700px){
  .mini-value{font-size:20px}
}

/* === overrides: titles smaller by 1 step; result values bigger by 1 step === */
.section-title{font-size:0.9em !important;}
#resultsCard .mini-value{font-size:14px !important;}
/* keep labels as is from last tweak (13px) */


#secGateTitle, #secResults{display:none !important;}

/* --- User tweaks (Feb 2025) --- */
/* Keep paired fields side-by-side even on mobile */
@media(max-width:600px){
  .row{grid-template-columns:1fr 1fr !important;}
}

/* Center the CTA buttons and bump font size one step */
.cta{justify-content:center;align-items:center}
.cta button{font-size:15px}

/* Also center if buttons wrap */
.cta{text-align:center}

/* Ensure buttons not stretched oddly */
.cta button{min-width:140px}

/* Just to be sure: place the two buttons next to each other nicely */
#calcBtn{order:1}
#resetBtn{order:2}


/* ===== Layout & Theme polish (final pass) ===== */

/* Fill the full safe viewport height; put background on <html> to avoid iOS gaps */
html{min-height:100svh;background:
  radial-gradient(900px 600px at 110% -10%, rgba(76,111,191,.10), transparent 50%),
  radial-gradient(700px 500px at -10% 110%, rgba(23,37,84,.12), transparent 55%),
  linear-gradient(180deg, #0a1530 0%, #0b1838 50%, #0a1226 100%);
}

/* Use flex column so footer sits at the bottom even with little content */
body{min-height:100svh;display:flex;flex-direction:column;background:transparent}

/* Main grows to push footer down */
main{flex:1}

/* Footer pinned to bottom naturally; add safe-area padding for iOS */
footer#copyright{
  margin-top:auto;
  padding:14px 16px calc(16px + env(safe-area-inset-bottom));
  text-align:center;
  color:#9fb0c7;
  border-top:1px solid rgba(255,255,255,.05);
  background:linear-gradient(180deg, rgba(10,21,48,.65), rgba(10,21,48,.85));
  backdrop-filter:saturate(140%) blur(6px);
}

/* Tidy header background to match the new theme */
header{background:linear-gradient(180deg, rgba(10,21,48,.92), rgba(10,21,48,.65));border-bottom:1px solid rgba(255,255,255,.06)}

/* Minimalist blue palette via CSS variables */
:root{
  --bg:#0b1838; --bg2:#0a1226; --card:#0e1a39; --line:#1c274a;
  --text:#eaf1ff; --muted:#9fb0c7; --accent:#4cc9f0; --accent2:#7c2ae8;
  --danger:#ff6b6b; --ok:#2dd4bf; --radius:16px;
}

/* Light mode palette (auto reacts to system theme) */
@media (prefers-color-scheme: light){
  :root{
    --bg:#f3f6fc; --bg2:#e9eef8; --card:#ffffff; --line:#d7e0f0;
    --text:#0b1220; --muted:#385076; --accent:#4660e6; --accent2:#9c42ff;
    --danger:#e5484d; --ok:#12a594;
  }
  html{background:
    radial-gradient(900px 600px at 110% -10%, rgba(70,96,230,.10), transparent 55%),
    linear-gradient(180deg, #f5f8ff 0%, #eef3ff 100%);}
  footer#copyright{background:linear-gradient(180deg, rgba(255,255,255,.9), rgba(255,255,255,.95)); border-top:1px solid var(--line); color:#2a3b59}
}

/* Cards pick up the new variables (keep subtle glass) */
.card{background:linear-gradient(180deg, rgba(255,255,255,.02), transparent 30%), var(--card);
  border:1px solid var(--line)}

/* Ensure no stray page gaps on very tall viewports */
#app, main{background:transparent}


/* === Final polish v2 === */

/* Cover viewport reliably on iOS/Android (dynamic toolbars) */
html, body{min-height:100dvh}
html{background:none}
body{
  /* Put background on body to avoid iOS white gaps */
  background:
    radial-gradient(900px 600px at 110% -10%, rgba(76,111,191,.10), transparent 50%),
    radial-gradient(700px 500px at -10% 110%, rgba(23,37,84,.12), transparent 55%),
    linear-gradient(180deg, var(--bg) 0%, var(--bg2) 100%);
  display:flex; flex-direction:column;
}

/* Main expands so footer sits at the very bottom when content is short */
main{flex:1; display:block}

/* Footer stays at page bottom; never floats under content */
footer#copyright{
  margin-top:auto;
  position:relative;
}

/* Safer color tokens inc. dedicated field surfaces */
:root{
  --bg:#0b1838; --bg2:#0a1226; --card:#0e1a39; --field:#0b1324; --line:#1c274a;
  --text:#eaf1ff; --muted:#9fb0c7; --accent:#4cc9f0; --accent2:#7c2ae8;
  --danger:#ff6b6b; --ok:#2dd4bf; --radius:16px;
}

/* Inputs pull from --field so they adapt in light mode */
input,select{background:var(--field);border:1px solid var(--line);color:var(--text)}

/* Light theme re-map for clean minimalist look */
@media (prefers-color-scheme: light){
  :root{
    --bg:#eef3ff; --bg2:#e6ebfb; --card:#ffffff; --field:#f5f7ff; --line:#d7e0f0;
    --text:#0b1220; --muted:#43567a; --accent:#4660e6; --accent2:#9c42ff;
    --danger:#e5484d; --ok:#12a594;
  }
  body{
    background:
      radial-gradient(900px 600px at 110% -10%, rgba(70,96,230,.10), transparent 55%),
      linear-gradient(180deg, var(--bg) 0%, var(--bg2) 100%);
  }
  header{background:linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.75)); border-bottom:1px solid var(--line)}
  .card{background:linear-gradient(180deg, rgba(70,96,230,.03), transparent 30%), var(--card);}
  label{color:#5a6a86}
  .secondary{background:var(--field); border:1px solid var(--line); color:var(--text)}
  footer#copyright{background:linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.98)); border-top:1px solid var(--line); color:#2a3b59}
}

/* Remove accidental page bottoms caused by margins collapsing */
main > *:last-child{margin-bottom:0}


/* === Cross‑browser fill + sticky footer — v3 === */

/* Fill viewport on iOS Safari (safe-area + dynamic bars) */
html, body {height:100%; min-height:100svh;}
/* Solid base color behind gradients to kill white gaps */
html{background-color: var(--bg);}
body{
  background-color: var(--bg);
  background-image:
    radial-gradient(900px 600px at 110% -10%, rgba(76,111,191,.10), transparent 50%),
    radial-gradient(700px 500px at -10% 110%, rgba(23,37,84,.12), transparent 55%),
    linear-gradient(180deg, var(--bg) 0%, var(--bg2) 100%);
  background-repeat:no-repeat;
  background-size:cover;
  display:flex; flex-direction:column;
  padding-bottom: env(safe-area-inset-bottom);
  margin:0;
}

/* Header safe-area to avoid top white strip on iOS */
header{padding-top: max(0px, env(safe-area-inset-top));}

/* Main stretches to push footer down */
main{flex:1 0 auto}

/* Footer anchored at bottom */
footer#copyright{margin-top:auto}

/* Light theme also sets solid base color to avoid white bands */
@media (prefers-color-scheme: light){
  html{background-color: var(--bg)}
  body{
    background-color: var(--bg);
    background-image:
      radial-gradient(900px 600px at 110% -10%, rgba(70,96,230,.10), transparent 55%),
      linear-gradient(180deg, var(--bg) 0%, var(--bg2) 100%);
  }
  input::placeholder{color:#7b89a6}
}

/* Inputs use field color in both modes */
input,select{background:var(--field);}

/* Prevent margin collapse at page end */
main > :last-child{margin-bottom:0}


/* === Footer structure fix & light-mode completeness (v4) === */

/* Body is flex; make <main> also flex column so footer inside it can push to bottom */
main{flex:1 0 auto; display:flex; flex-direction:column}

/* Footer inside <main> sticks to the bottom of main */
footer#copyright{margin-top:auto}

/* Normalize component surfaces to use tokens (works in both themes) */
.toggle{background:var(--field); border:1px dashed var(--line)}
.lang{border-color:var(--line)}
.lang button{color:var(--muted)}
input,select{background:var(--field); color:var(--text); border-color:var(--line)}
.card{background:linear-gradient(180deg, rgba(255,255,255,.02), transparent 30%), var(--card); border-color:var(--line)}
.error{background:rgba(229,72,77,.12); border:1px solid rgba(229,72,77,.35); color:inherit}

/* Ensure color-scheme hints for form controls */
:root{color-scheme: light dark}


/* === Minimal footer + secondary button fix (v5) === */

/* Footer: text-only look, no box backdrop in both modes */
footer#copyright{
  background: none !important;
  border: 0 !important;
  box-shadow: none !important;
  padding: 12px 16px calc(12px + env(safe-area-inset-bottom));
  color: var(--muted);
}

/* Secondary button must adapt in light mode even when disabled */
button.secondary{background: var(--field); border:1px solid var(--line); color: var(--text)}
button.secondary:disabled{background: var(--field); border:1px solid var(--line); color: var(--muted); opacity:.7}

/* Ensure the gradient rule for generic buttons never overrides .secondary */
button:not(.secondary){background:linear-gradient(135deg,var(--accent),var(--accent2)); color:white; border:0}


/* === Restore language toggle exact look === */
.lang{display:flex;align-items:center;border:1px solid var(--line);border-radius:999px;overflow:hidden;background:transparent}
.lang button{background:transparent !important;color:#bcd0ef !important;border:none;padding:8px 14px;cursor:pointer;font-weight:800;min-width:52px}
.lang button.active{color:#fff !important;background:linear-gradient(135deg,var(--accent2),var(--accent)) !important}

/* Light mode text color for inactive language button (to match original contrast) */
@media (prefers-color-scheme: light){
  .lang button{color:#2a3b59 !important}
}


/* === Alignment & spacing tweaks (v6) === */

/* Align form controls in each .row to the same baseline regardless of label wrapping */
.row{align-items:end}

/* Extra comfortable gap between the 'sex' card and the inputs card */
#gateCard{margin-bottom:22px}

</style>
</head>
<body>
<header>
  <div class="nav">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <h1 class="title" id="appTitle">حاسبة سعرات القط</h1>
    </div>
    <div class="lang" role="tablist" aria-label="Language">
      <button id="btnAR" class="active" aria-selected="true">ع</button>
      <button id="btnEN" aria-selected="false">E</button>
    </div>
  </div>
</header>

<main>
  <section class="card" id="gateCard">
    <h2 class="section-title" id="secGateTitle">اختر الجنس للمتابعة</h2>
    <label id="lblSexGate">جنس القطة</label>
    <select id="sex"></select>
  </section>

  <div class="grid hide" id="calcGrid">
    <section class="card">
<h2 class="section-title" id="secInputs" style="display: none;"></h2>

      <label id="lblW">الوزن الحالي (كجم)</label>
      <input id="wcur" type="text" inputmode="decimal" placeholder="مثال: ٠٫٩">

      <label id="lblBase" style="margin-top:12px">الفئة العمرية/الحالة الأساسية</label>
      <div class="row">
        <select id="baseCategory"></select>
        <div id="baseNumberWrap"><select id="baseNumber"></select></div>
        <div id="adultActivityWrap" class="hide"><select id="adultActivity"></select></div>
      </div>

      <div id="reproToggles" class="toggles hide">
        <label class="toggle" id="pregToggle"><input id="isPreg" type="checkbox"> <span id="txtPreg">حامل</span></label>
        <label class="toggle" id="lacToggle"><input id="isLac" type="checkbox"> <span id="txtLac">مرضعة</span></label>
      </div>

      <div id="pregBlock" class="row hide" style="margin-top:6px">
        <div>
          <label id="lblPreW">الوزن قبل الحمل (كجم)</label>
          <input id="prePregW" type="text" inputmode="decimal" placeholder="مثال: ٣٫٨">
        </div>
        <div>
          <label id="lblPregWeek">أسبوع الحمل</label>
          <select id="pregWeek"></select>
        </div>
      </div>

      <div id="lacBlock" class="row hide" style="margin-top:6px">
        <div>
          <label id="lblLitter">عدد الصغار</label>
          <select id="litter"></select>
        </div>
        <div>
          <label id="lblLacWeek">أسبوع الإرضاع</label>
          <select id="lacWeek"></select>
        </div>
      </div>

      <div class="error" id="errorAll"></div>
      <div class="cta">
        <button id="calcBtn">احسب النتائج</button>
        <button class="secondary" id="resetBtn">إعادة ضبط</button>
      </div>
    </section>

   
<section class="card hide" id="resultsCard">
  <h2 class="section-title" id="secResults">النتائج</h2>
  <div class="result-grid" id="resultGrid">
    <div class="mini"><div class="mini-label" id="r1k">السعرات اليومية</div><div class="mini-value" id="r1v">0 kcal</div></div>
    <div class="mini"><div class="mini-label" id="r2k">عدد الوجبات</div><div class="mini-value" id="r2v">0</div></div>
    <div class="mini"><div class="mini-label" id="r4k">السعرات في كل وجبة</div><div class="mini-value" id="r4v">0</div></div>
    <div class="mini"><div class="mini-label" id="r3k">الأكل الحر</div><div class="mini-value" id="r3v">—</div></div>
  </div>
  <div class="small" id="note" class="hide"></div>
</section>

  </div>

  <footer id="copyright">© Albraichy 2025 — جميع الحقوق محفوظة</footer>
</main>

<script>
/* ---------- I18N + helpers ---------- */
const I18N = {
  ar:{
    dir:"rtl", appTitle:"حاسبة سعرات القط", gateTitle:"اختر الجنس للمتابعة", sex:"جنس القطة",
    sexOptions:[["","— اختر —"],["male","ذكر"],["female","أنثى"]],
    inputs:"المدخلات", results:"النتائج",
    w:"الوزن الحالي (كجم)", wPh:"مثال: ٠٫٩", base:"الفئة العمرية/الحالة الأساسية",
    small_f:"صغيرة (٢–٤ أشهر)", mid_f:"متوسطة (٥–١٢ شهر)", adult_f:"بالغة (أكبر من سنة)", spayed_f:"معقمة",
    small_m:"صغير (٢–٤ أشهر)",  mid_m:"متوسط (٥–١٢ شهر)",   adult_m:"بالغ (أكبر من سنة)",  spayed_m:"معقم",
    low:"نشاط قليل", med:"نشاط متوسط", high:"نشاط عالي",
    preg:"حامل", lact:"مرضعة",
    preW:"الوزن قبل الحمل (كجم)", preWph:"مثال: ٣٫٨",
    pregWeek:"أسبوع الحمل", litter:"عدد الصغار", lacWeek:"أسبوع الإرضاع",
    calc:"احسب النتائج", reset:"إعادة ضبط",
    daily:"السعرات اليومية", meals:"عدد الوجبات", perMeal:"السعرات بالوجبة", free:"الأكل الحر",
    freeYes:(g)=>`مع أكل حر — المطلوب تقريباً ${g} غ`, freeNo:"بدون أكل حر",
    errW:"أدخل الوزن الحالي بشكل صحيح (أكبر من صفر).",
    errWeeks:"الأسابيع يجب أن تكون بين ٥ و ١٦.", errMonths:"الأشهر يجب أن تكون بين ٥ و ١٢.",
    errPreW:"الوزن قبل الحمل مطلوب عند اختيار (حامل).",
    copyright:"© Albraichy 2025 — جميع الحقوق محفوظة",
    week:(n)=>`الأسبوع ${n}`, month:(n)=>`الشهر ${n}`,
    kittenCounts:[["le2","≤٢"],["3-4","٣–٤"],["5-6","٥–٦"],["ge7","≥٧"]],
    pregWeeks:[["1-4","١–٤"],["5","٥"],["6","٦"],["7","٧"],["8","٨"],["9","٩"]],
  },
  en:{
    dir:"ltr", appTitle:"Cat Calorie Calculator", gateTitle:"Choose sex to continue", sex:"Cat’s Sex",
    sexOptions:[["","— Select —"],["male","Male"],["female","Female"]],
    inputs:"Inputs", results:"Results",
    w:"Current Weight (kg)", wPh:"e.g., 0.9", base:"Age / Base Condition",
    small_f:"Kitten (2–4 mo)", mid_f:"Kitten (5–12 mo)", adult_f:"Adult (>1 yr)", spayed_f:"Spayed",
    small_m:"Kitten (2–4 mo)", mid_m:"Kitten (5–12 mo)", adult_m:"Adult (>1 yr)", spayed_m:"Neutered",
    low:"Low Activity", med:"Moderate Activity", high:"High Activity",
    preg:"Pregnant", lact:"Lactating",
    preW:"Pre‑pregnancy Weight (kg)", preWph:"e.g., 3.8",
    pregWeek:"Pregnancy Week", litter:"Kitten Count", lacWeek:"Lactation Week",
    calc:"Calculate", reset:"Reset",
    daily:"Daily Calories", meals:"Meals per Day", perMeal:"kcal per Meal", free:"Free‑feeding",
    freeYes:(g)=>`Allowed — dry food ≈ ${g} g`, freeNo:"Not allowed",
    errW:"Enter a valid weight (> 0).",
    errWeeks:"Weeks must be between 5 and 16.", errMonths:"Months must be between 5 and 12.",
    errPreW:"Pre‑pregnancy weight is required when 'Pregnant' is selected.",
    copyright:"© Albraichy 2025 — All rights reserved",
    week:(n)=>`Week ${n}`, month:(n)=>`Month ${n}`,
    kittenCounts:[["le2","≤2"],["3-4","3–4"],["5-6","5–6"],["ge7","≥7"]],
    pregWeeks:[["1-4","1–4"],["5","5"],["6","6"],["7","7"],["8","8"],["9","9"]],
  }
};
let LANG='ar';
const $ = (id)=>document.getElementById(id);
function setSelectOptions(sel, arr, keepValue=null){
  const val = keepValue ?? sel.value;
  sel.innerHTML='';
  arr.forEach(([v,txt])=>{const o=document.createElement('option');o.value=v;o.textContent=txt;sel.appendChild(o);});
  if(val && [...sel.options].some(o=>o.value===val)) sel.value = val;
}
function toASCII(s){
  if(!s) return '';
  const map={'٠':'0','١':'1','٢':'2','٣':'3','٤':'4','٥':'5','٦':'6','٧':'7','٨':'8','٩':'9','٫':'.',',':'.',' ':'','\u200f':''};
  return s.toString().split('').map(c => (c in map)?map[c]:c).join('');
}

/* ---------- tables ---------- */
const A_small={5:2.50,6:2.45,7:2.40,8:2.35,9:2.30,10:2.25,11:2.20,12:2.15,13:2.10,14:2.10,15:2.00,16:2.00};
const A_mid={5:1.95,6:1.90,7:1.85,8:1.80,9:1.75,10:1.50,11:1.50,12:1.50};
const A_adult={low:0.90,med:1.00,high:1.10};
const A_spayed={low:0.75,med:0.85,high:0.95};
const P_preg={'1-4':1.00,'5':1.10,'6':1.20,'7':1.30,'8':1.40,'9':1.45};
const L_lac={
  1:{'le2':1.6,'3-4':1.8,'5-6':2.0,'ge7':2.2},
  2:{'le2':1.8,'3-4':2.2,'5-6':2.5,'ge7':2.7},
  3:{'le2':2.0,'3-4':2.5,'5-6':2.8,'ge7':3.0},
  4:{'le2':2.0,'3-4':2.5,'5-6':3.0,'ge7':3.0},
  5:{'le2':1.8,'3-4':2.3,'5-6':2.6,'ge7':2.7},
  6:{'le2':1.6,'3-4':2.1,'5-6':2.3,'ge7':2.4},
  7:{'le2':1.3,'3-4':1.7,'5-6':1.9,'ge7':2.0},
  8:{'le2':1.2,'3-4':1.4,'5-6':1.5,'ge7':1.6},
  9:{'le2':1.05,'3-4':1.2,'5-6':1.25,'ge7':1.3},
  10:{'le2':1.0,'3-4':1.0,'5-6':1.0,'ge7':1.0}
};

/* ---------- element refs ---------- */
const appTitle=$('appTitle'), secGateTitle=$('secGateTitle'), lblSexGate=$('lblSexGate');
const gateCard=$('gateCard'), calcGrid=$('calcGrid'), sex=$('sex');
const secInputs=$('secInputs'), secResults=$('secResults');
const lblW=$('lblW'), wcur=$('wcur'), lblBase=$('lblBase');
const baseCategory=$('baseCategory'), baseNumber=$('baseNumber'), baseNumberWrap=$('baseNumberWrap');
const adultActivity=$('adultActivity'), adultActivityWrap=$('adultActivityWrap');
const reproToggles=$('reproToggles'), pregToggle=$('pregToggle'), lacToggle=$('lacToggle');
const isPreg=$('isPreg'), isLac=$('isLac'), txtPreg=$('txtPreg'), txtLac=$('txtLac');
const pregBlock=$('pregBlock'), prePregW=$('prePregW'), lblPreW=$('lblPreW'), pregWeek=$('pregWeek'), lblPregWeek=$('lblPregWeek');
const lacBlock=$('lacBlock'), litter=$('litter'), lblLitter=$('lblLitter'), lacWeek=$('lacWeek'), lblLacWeek=$('lblLacWeek');
const calcBtn=$('calcBtn'), resetBtn=$('resetBtn'), errorAll=$('errorAll');
const r1k=$('r1k'), r2k=$('r2k'), r3k=$('r3k'), r1v=$('r1v'), r2v=$('r2v'), r3v=$('r3v'), copyright=$('copyright');
const resultsCard=$('resultsCard'), note=$('note');

/* ---------- UI builders ---------- */
function refillBaseNumber(){
  const i = I18N[LANG];
  baseNumber.innerHTML='';
  const cat=baseCategory.value;
  if(cat==='kitten_small'){ for(let w=5; w<=16; w++){ const o=document.createElement('option'); o.value=String(w); o.textContent=i.week(w); baseNumber.appendChild(o);} }
  else if(cat==='kitten_mid'){ for(let m=5; m<=12; m++){ const o=document.createElement('option'); o.value=String(m); o.textContent=i.month(m); baseNumber.appendChild(o);} }
}
function refreshBaseControls(){
  const c=baseCategory.value;
  baseNumberWrap.classList.add('hide'); adultActivityWrap.classList.add('hide');
  if(c==='kitten_small'||c==='kitten_mid') baseNumberWrap.classList.remove('hide');
  if(c==='adult'||c==='spayed') adultActivityWrap.classList.remove('hide');

  // Reproductive visibility rules
  const isMale = (sex.value==='male');
  let pregAllowed=false, lacAllowed=false, showToggles=false;

  if(!isMale){
    if(c==='spayed'){ pregAllowed=false; lacAllowed=false; showToggles=false; }
    else if(c==='kitten_small'){
      const wk=parseInt(baseNumber.value||'0',10);
      pregAllowed = (wk===16);     // only at week 16
      lacAllowed = false;          // never for kittens
      showToggles = pregAllowed;   // show only if pregnancy allowed
    }
    else if(c==='kitten_mid'){ pregAllowed=true; lacAllowed=true; showToggles=true; }
    else if(c==='adult'){ pregAllowed=true; lacAllowed=true; showToggles=true; }
  }

  // Apply
  reproToggles.classList.toggle('hide', !showToggles);
  pregToggle.classList.toggle('hide', !pregAllowed);
  lacToggle.classList.toggle('hide', !lacAllowed);
  // never show for male
  if(isMale){ isPreg.checked=false; isLac.checked=false; }
  isPreg.disabled=!pregAllowed; if(!pregAllowed) isPreg.checked=false;
  isLac.disabled=!lacAllowed;   if(!lacAllowed) isLac.checked=false;

  // blocks visibility
  pregBlock.classList.toggle('hide', !(isPreg.checked && pregAllowed));
  lacBlock.classList.toggle('hide',  !(isLac.checked && lacAllowed));
}
function rebuildUITexts(){
  const i=I18N[LANG];
  document.documentElement.lang=LANG; document.documentElement.dir=i.dir;
  appTitle.textContent=i.appTitle;
  secGateTitle.textContent=i.gateTitle; lblSexGate.textContent=i.sex;
  secInputs.textContent=i.inputs; secResults.textContent=i.results;
  lblW.textContent=i.w; wcur.placeholder=i.wPh; lblBase.textContent=i.base;
  txtPreg.textContent=i.preg; txtLac.textContent=i.lact;
  lblPreW.textContent=i.preW; prePregW.placeholder=i.preWph; lblPregWeek.textContent=i.pregWeek;
  lblLitter.textContent=i.litter; lblLacWeek.textContent=i.lacWeek;
  calcBtn.textContent=i.calc; resetBtn.textContent=i.reset;
  r1k.textContent=i.daily; r2k.textContent=i.meals; r4k.textContent=i.perMeal; r3k.textContent=i.free; copyright.textContent=i.copyright;

  // Preserve current selections
  const currentSex = sex.value;
  const currentBase = baseCategory.value;
  const currentActivity = adultActivity.value;
  const currentBaseNum = baseNumber.value;

  setSelectOptions(sex, i.sexOptions, currentSex);

  const male = (sex.value==='male');
  const baseArr = male ?
    [['kitten_small',i.small_m],['kitten_mid',i.mid_m],['adult',i.adult_m],['spayed',i.spayed_m]] :
    [['kitten_small',i.small_f],['kitten_mid',i.mid_f],['adult',i.adult_f],['spayed',i.spayed_f]];
  setSelectOptions(baseCategory, baseArr, currentBase || 'kitten_small');

  setSelectOptions(adultActivity, [['low',i.low],['med',i.med],['high',i.high]], currentActivity || 'low');
  setSelectOptions(pregWeek, i.pregWeeks);
  const lacWeeks=[]; for(let w=1; w<=10; w++) lacWeeks.push([String(w), i.week(w)]);
  setSelectOptions(lacWeek, lacWeeks);
  setSelectOptions(litter, i.kittenCounts);
  refillBaseNumber();
  if(currentBaseNum) baseNumber.value=currentBaseNum;
  refreshBaseControls();
}

/* ---------- language + sex handlers ---------- */
function setLang(lang){
  LANG=lang;
  document.getElementById('btnAR').classList.toggle('active', LANG==='ar');
  document.getElementById('btnEN').classList.toggle('active', LANG==='en');
  rebuildUITexts();
  // Always hide results when language toggles to avoid stale mixed text
  resultsCard.classList.add('hide');
}
function onSexChange(){
  // Hide results until a calculation is done
  resultsCard.classList.add('hide');
  if(sex.value){
    calcGrid.classList.remove('hide');
  }else{
    calcGrid.classList.add('hide');
  }
  rebuildUITexts();
}

/* ---------- validation & calculations ---------- */
function showError(msg){ errorAll.textContent=msg; errorAll.style.display='block'; }
function clearError(){ errorAll.textContent=''; errorAll.style.display='none'; }

function calc(){
  clearError();
  const i=I18N[LANG];
  const w=parseFloat(toASCII(wcur.value));
  if(!(w>0)){ showError(i.errW); resultsCard.classList.add('hide'); return; }

  const cat=baseCategory.value;
  let A=1, baseFree=false;
  if(cat==='kitten_small'){
    const wk=parseInt(baseNumber.value,10);
    if(!(wk>=5 && wk<=16)){ showError(i.errWeeks); resultsCard.classList.add('hide'); return; }
    A=A_small[wk]; baseFree = (wk>=5 && wk<=14);
  }else if(cat==='kitten_mid'){
    const mo=parseInt(baseNumber.value,10);
    if(!(mo>=5 && mo<=12)){ showError(i.errMonths); resultsCard.classList.add('hide'); return; }
    A=A_mid[mo]; baseFree=false;
  }else if(cat==='adult'){ A=A_adult[adultActivity.value]; baseFree = (adultActivity.value==='high'); }
  else if(cat==='spayed'){ A=A_spayed[adultActivity.value]; baseFree = (adultActivity.value==='high'); }

  let P=1, weightAdj=1, pregFree=false;
  if(isPreg.checked && !isPreg.disabled){
    const wk=pregWeek.value;
    const wprior=parseFloat(toASCII(prePregW.value));
    if(!(wprior>0)){ showError(i.errPreW); resultsCard.classList.add('hide'); return; }
    P=P_preg[wk];
    weightAdj = 1.0 / Math.pow((w / wprior), 0.67);
    pregFree = (wk!=='1-4' && wk!=='5'); // from week 6 and above
  }

  let L=1, lacFree=false;
  if(isLac.checked && !isLac.disabled){
    const lw=parseInt(lacWeek.value,10);
    const lc=litter.value;
    L = L_lac[lw][lc];
    lacFree = (L>=2.2);
  }

  const freeAllowed = !!(baseFree || pregFree || lacFree);

  const calories = 100 * Math.pow(w,0.67) * A * P * weightAdj * L;

  const perMeal = 40*w;
  let meals, freeText=i.freeNo;
  if(freeAllowed){
    let n = Math.floor(calories / perMeal) - 1;
    if(n < 1) n = 1;
    const deltaC = Math.max(0, calories - n*perMeal);
    const dry = Math.max(0, deltaC/4);
    freeText = (LANG==='en' ? (dry.toFixed(2) + ' g') : (dry.toFixed(2) + ' غ'));
    meals = n;
  }else{
    // IMPORTANT FIX: when free‑feeding is NOT allowed, use CEIL for number of meals
    let n = Math.ceil(calories / perMeal);
    if(n < 1) n = 1;
    meals = n;
    freeText = '🚫';
  }

  r1v.textContent = calories.toFixed(2) + ' kcal';
  r2v.textContent = String(meals);
  r4v.textContent = perMeal.toFixed(2) + ' kcal';
  r3v.textContent = freeText;
  
try{
  if (typeof LANG!=='undefined' && LANG==='en') {
    var fv = document.getElementById('r3v');
    if (fv && /\d/.test(fv.textContent || '')) {
      fv.textContent = fv.textContent.replace('غ','g');
    }
  }
}catch(e){};

  resultsCard.classList.remove('hide');
}

function resetAll(){
  wcur.value=''; prePregW.value=''; isPreg.checked=false; isLac.checked=false;
  r1v.textContent='0 kcal'; r2v.textContent='0'; r3v.textContent='—'; clearError();
  resultsCard.classList.add('hide');
  rebuildUITexts();
}

/* ---------- wire events & init ---------- */
document.getElementById('btnAR').addEventListener('click', ()=>setLang('ar'));
document.getElementById('btnEN').addEventListener('click', ()=>setLang('en'));
sex.addEventListener('change', onSexChange);
baseCategory.addEventListener('change', ()=>{ refillBaseNumber(); refreshBaseControls(); resultsCard.classList.add('hide'); });
baseNumber.addEventListener('change', ()=>{ refreshBaseControls(); resultsCard.classList.add('hide'); });
adultActivity.addEventListener('change', ()=>{ refreshBaseControls(); resultsCard.classList.add('hide'); });
isPreg.addEventListener('change', ()=>{ pregBlock.classList.toggle('hide', !isPreg.checked); resultsCard.classList.add('hide'); });
isLac.addEventListener('change', ()=>{ lacBlock.classList.toggle('hide', !isLac.checked); resultsCard.classList.add('hide'); });
calcBtn.addEventListener('click', calc);
resetBtn.addEventListener('click', resetAll);

function init(){
  // start AR, hidden calc grid, and empty sex
  setSelectOptions(sex, I18N[LANG].sexOptions);
  calcGrid.classList.add('hide');
  resultsCard.classList.add('hide'); // ensure hidden at start
  rebuildUITexts();
}
init();
</script>
</body>
</html>
